<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± V2 - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* --- å®Œæ•´ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰ CSS (14pt, å ±è¡¨æ¨£å¼ç­‰) --- */
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --project: #e67e22; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* V2 æ–°å¢ï¼šäººå“¡çŸ©é™£æŒ‰éˆ• */
        .staff-matrix { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 25px; }
        .staff-btn { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; position: relative; }
        .staff-btn.active { border-color: var(--accent); background: #e3f2fd; }
        .staff-btn .name { font-size: 1.3rem; font-weight: bold; }

        /* æ‚¨çš„åŸå§‹æ¨£å¼åº« */
        .score-container { display: flex; flex-direction: column; gap: 12px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 8px solid var(--primary); margin-bottom: 20px; }
        .score-grid { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .avg-display { min-width: 180px; background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.3rem; font-weight: bold; }
        .target-input { width: 130px; height: 50px; color: var(--danger); font-size: 1.5rem; border: 2px solid var(--danger); text-align: center; font-weight: bold; background: #fff5f5; border-radius: 8px; }
        .excel-report th, .excel-report td { border: 1px solid #000 !important; padding: 12px 8px; font-size: 18px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">ğŸ‘¤ é¸æ“‡äººå“¡ (å…¨è™›æ“¬è³‡æ–™å°é½Š)</h2>
    <div id="staffMatrix" class="staff-matrix"></div>
</div>

<div class="card">
    <div class="header-controls" style="display:flex; gap:20px; align-items:center;">
        <span style="font-size: 1.2rem; font-weight: bold;">ğŸ“… å¹´åº¦ï¼š</span>
        <select id="calcYear" onchange="autoCalc(true)" style="padding:12px; font-size:1.2rem; border-radius:10px;">
            <option value="2023">2023</option><option value="2024">2024</option>
            <option value="2025" selected>2025</option><option value="2026">2026</option>
        </select>
        <button class="btn" style="background:var(--success); color:white; padding:12px 25px; border:none; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="handleFinalSave()">ğŸ’¾ å„²å­˜æ•¸æ“š</button>
        <button id="unlockBtn" class="btn" style="background:var(--danger); margin-left:auto; color:white; padding:12px 25px; border:none; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="askPassword()">ğŸ”’ ä¸»ç®¡æˆæ¬Š</button>
    </div>

    <div class="score-container">
        <div id="annualInputs" class="score-grid"></div>
        <div class="avg-display">å¹´åº¦å¹³å‡ï¼š<span id="avgSpan">0.00</span></div>
    </div>

    <div class="score-container" style="border-left-color: var(--project); background: #fdf5e6;">
        <div id="projInputs" class="score-grid"></div>
        <div class="avg-display" style="background:var(--project);">å°ˆæ¡ˆå¹³å‡ï¼š<span id="projAvgSpan">0.00</span></div>
    </div>
    
    <div style="height:400px; margin-top:20px;"><canvas id="scoreChart"></canvas></div>
</div>

<div id="adminZone" style="display:none;">
    <div class="card" style="border: 2px solid var(--danger);">
        <h2 style="color:var(--danger);">ä¸»ç®¡çé‡‘æ ¸å®š</h2>
        <table id="adminTable" style="width:100%; text-align:center; border-collapse:collapse;">
            <thead><tr style="background:#f4f4f4; height: 45px;"><th>å§“å</th><th>å¹´åº¦</th><th>å¹³å‡åˆ†</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>å°ˆæ¡ˆ</th><th>ç¸½è¨ˆé¡</th></tr></thead>
            <tbody id="resultBody"></tbody>
        </table>
        </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxmNA0AYmcKK5x4iKZz0FwujvvtS4nioZ7fjXLe-oBlaye6qRfIf_WV8gp-Fj9vZPe1OA/exec";
    let selectedEmp = "", selectedRank = "", selectedSalary = 0, timelineData = {};
    Chart.register(ChartDataLabels);

    // V2 æ–°å¢ï¼šåˆå§‹åŒ–æŠ“å–äººå“¡
    window.onload = async () => {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getStaff"})});
        const r = await res.json();
        renderStaffButtons(r.data);
    };

    function renderStaffButtons(data) {
        document.getElementById('staffMatrix').innerHTML = data.map(s => `
            <div class="staff-btn" onclick="selectStaff('${s[0]}')">
                <span class="name">${s[0]}</span>
                <div style="font-size:0.8rem; color:gray;">${s[1]} | ${new Date(s[3]).getFullYear()}å…¥è·</div>
            </div>
        `).join('');
    }

    async function selectStaff(name) {
        selectedEmp = name;
        document.querySelectorAll('.staff-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(name)));
        
        // æ ¸å¿ƒï¼šé€£å‹•æŠ“å–è–ªè³‡å­˜æ‘º
        const year = document.getElementById('calcYear').value;
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({
            action: "getEffectiveSalary", name: name, date: `${year}-01-01`
        })});
        const r = await res.json();
        selectedSalary = r.salary;
        selectedRank = r.rank;

        // è§¸ç™¼æ‚¨åŸæœ¬çš„ initUI åŠŸèƒ½
        initUI_V2();
    }

    function initUI_V2() {
        // é€™é‚Šæ¥å›æ‚¨åŸæœ¬çš„ initUI é‚è¼¯ï¼šåˆ¤æ–· L1 é¡¯ç¤º12å€‹æœˆé‚„æ˜¯4å­£
        // ä¸¦å°‡æŠ“åˆ°çš„è–ªè³‡å¸¶å…¥ timelineData
        autoCalc(true); 
    }

    /* --- è«‹åœ¨æ­¤è™•è²¼å›æ‚¨åŸæœ¬å¼·å¤§çš„ JavaScript å‡½æ•¸åº« --- */
    /* åŒ…å«ï¼šrunLiveCalc, updateAdminTableUI, openReport, handleFinalSave, downloadChart ç­‰ */
    
</script>
</body>
</html>
