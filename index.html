<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HR è–ªé…¬å·¥ä½œç«™ V2 - è™›æ“¬æ¸¬è©¦ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* çŸ©é™£æŒ‰éˆ•æ¨£å¼ */
        .staff-matrix { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .staff-btn { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 10px; cursor: pointer; text-align: center; position: relative; transition: 0.3s; }
        .staff-btn.active { border-color: var(--accent); background: #e3f2fd; transform: scale(1.05); }
        .staff-btn .rank-tag { position: absolute; top: 5px; right: 5px; background: #eee; font-size: 10px; padding: 2px 4px; border-radius: 4px; }

        /* åˆ†é æŒ‰éˆ• */
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 30px; border-radius: 8px; border: none; cursor: pointer; font-size: 1.1rem; font-weight: bold; background: #ccc; }
        .tab-btn.active { background: var(--primary); color: white; }
        .pane { display: none; }
        .pane.active { display: block; }

        /* æ‚¨çš„ 14pt æ¨™æº–æ¨£å¼ */
        .q-score { width: 80px; height: 45px; text-align: center; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; }
        .btn { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">ğŸ‘¤ äººå“¡é¸æ“‡ (å…¨è™›æ“¬æ•¸æ“šå°é½Š)</h2>
    <div id="staffMatrix" class="staff-matrix">æ­£åœ¨è¼‰å…¥äººå“¡åå–®...</div>
</div>

<div class="tab-bar">
    <button id="btnB" class="tab-btn active" onclick="switchTab('bonus')">ğŸ“Š çé‡‘æ ¸å®š</button>
    <button id="btnS" class="tab-btn" onclick="switchTab('salary')">ğŸ“ˆ è–ªè³‡æ±ºç­– (ğŸ”’)</button>
</div>

<div id="paneBonus" class="pane active">
    <div class="card">
        <div style="display:flex; gap:20px; align-items:center;">
            <span>ğŸ“… å¹´åº¦ï¼š</span>
            <select id="calcYear" onchange="autoCalc(true)" style="padding:10px; font-size:1.1rem;">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
            </select>
            <button class="btn" style="background:var(--success);" onclick="handleFinalSave()">ğŸ’¾ å„²å­˜</button>
            <button id="unlockBtn" class="btn" style="background:var(--danger); margin-left:auto;" onclick="askPassword()">ğŸ”’ ä¸»ç®¡æˆæ¬Š</button>
        </div>
        
        <div id="annualInputs" class="score-grid" style="margin-top:20px;"></div>
        <div style="margin-top:15px; font-size:1.3rem; font-weight:bold;">å¹´åº¦å¹³å‡ï¼š<span id="avgSpan">0.00</span></div>
    </div>
    
    <div id="adminZone" style="display:none;" class="card">
        <h3 style="color:var(--danger);">ä¸»ç®¡æ ¸å®šå€</h3>
        <div id="resultBody"></div>
    </div>
</div>

<div id="paneSalary" class="pane">
    <div class="card">
        <h3>ğŸ“ˆ è–ªè³‡æ­·ç¨‹èˆ‡ 2026 æ±ºè­°</h3>
        <div id="salaryLogContainer"></div>
    </div>
</div>

<script>
    const API_URL = "ä½ çš„_GAS_éƒ¨ç½²ç¶²å€";
    let selectedName = "", selectedRank = "", selectedSalary = 0;

    window.onload = async () => {
        try {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getStaff" })
            });
            const r = await res.json();
            if(r.status === "success") renderStaffMatrix(r.data);
        } catch (e) { console.error("åˆå§‹åŒ–å¤±æ•—:", e); }
    };

    function renderStaffMatrix(data) {
        const m = document.getElementById('staffMatrix');
        m.innerHTML = data.map(s => `
            <div class="staff-btn" onclick="selectStaff('${s[0]}', '${s[2]}')">
                <span class="rank-tag">${s[2]}</span>
                <span style="font-size:1.2rem; font-weight:bold;">${s[0]}</span>
                <div style="font-size:0.8rem; color:#666;">${new Date(s[1]).getFullYear()}å…¥è·</div>
            </div>
        `).join('');
    }

    async function selectStaff(name, rank) {
        selectedName = name;
        document.querySelectorAll('.staff-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(name)));
        
        // æŠ“å–è–ªè³‡
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getEffectiveSalary", name: name, date: "2025-01-01" })
        });
        const r = await res.json();
        selectedSalary = r.salary;
        selectedRank = r.rank;
        
        // åŸ·è¡ŒåŸæœ‰è¨ˆç®—
        autoCalc(true);
    }

    async function switchTab(tab) {
        if(tab === 'salary') {
            const pwd = prompt("è«‹è¼¸å…¥æœ€é«˜æ¬Šé™å¯†ç¢¼ï¼š");
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verifyLevel", pwd: pwd }) });
            const r = await res.json();
            if(r.status === "success") {
                document.getElementById('paneBonus').classList.remove('active');
                document.getElementById('paneSalary').classList.add('active');
            } else alert("å¯†ç¢¼éŒ¯èª¤");
        } else {
            document.getElementById('paneSalary').classList.remove('active');
            document.getElementById('paneBonus').classList.add('active');
        }
    }

    // --- æ­¤è™•è«‹è²¼å›æ‚¨åŸæœ¬å‰©é¤˜çš„è¨ˆç®—å‡½æ•¸ (autoCalc, runLiveCalc ç­‰) ---
</script>
</body>
</html>
