<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± V2 - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei"; background: var(--bg); padding: 20px; font-size: 14pt; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* V2 äººå“¡çŸ©é™£ */
        .staff-matrix { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .staff-btn { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .staff-btn.active { border-color: var(--accent); background: #e3f2fd; transform: scale(1.05); }
        .staff-btn .rank-tag { position: absolute; top: 5px; right: 5px; font-size: 10px; background: #eee; padding: 2px 4px; border-radius: 4px; }

        /* æ‚¨åŸæœ¬çš„è¼¸å…¥æ¡†èˆ‡å ±è¡¨æ¨£å¼ (14pt/18px) */
        .q-score { width: 85px; height: 45px; text-align: center; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; }
        .score-container { display: flex; flex-direction: column; gap: 15px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 8px solid var(--primary); margin-bottom: 20px; }
        .avg-display { background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; }
        
        /* å ±è¡¨å°ˆç”¨æ¨£å¼ */
        .excel-report { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .excel-report th, .excel-report td { border: 1px solid #000; padding: 12px; text-align: center; font-size: 18px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">ğŸ‘¤ é¸æ“‡äººå“¡</h2>
    <div id="staffMatrix" class="staff-matrix">è¼‰å…¥åå–®ä¸­...</div>
</div>

<div class="card">
    <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px;">
        <span style="font-weight:bold;">ğŸ“… å¹´åº¦ï¼š</span>
        <select id="calcYear" onchange="refreshAll()" style="padding:10px; font-size:1.1rem; border-radius:8px;">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
        </select>
        <button class="btn" style="background:var(--success); color:white; padding:10px 20px; border:none; border-radius:8px;" onclick="saveData()">ğŸ’¾ å„²å­˜</button>
        <button id="unlockBtn" style="background:var(--danger); color:white; padding:10px 20px; border:none; border-radius:8px; margin-left:auto;" onclick="verifyAdmin()">ğŸ”’ ä¸»ç®¡æˆæ¬Š</button>
    </div>

    <div class="score-container" id="perfSection">
        <div id="inputGrid" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
        <div class="avg-display">å¹´åº¦å¹³å‡åˆ†æ•¸ï¼š<span id="avgSpan">0.00</span></div>
    </div>

    <div style="height:350px;"><canvas id="mainChart"></canvas></div>
</div>

<div id="adminZone" style="display:none;" class="card">
    <h3 style="color:var(--danger);">ä¸»ç®¡çé‡‘æ ¸å®š (å«æ‰‹å‹•èª¿æ•´)</h3>
    <div id="resultTableContainer"></div>
    <div style="margin-top:20px; display:flex; gap:10px;">
        <button onclick="openPersonalReport()">ğŸ“„ å€‹äººæ ¸å®šå ±è¡¨</button>
        <button onclick="downloadChart()">ğŸ–¼ï¸ ä¸‹è¼‰è¶¨å‹¢åœ–</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxmNA0AYmcKK5x4iKZz0FwujvvtS4nioZ7fjXLe-oBlaye6qRfIf_WV8gp-Fj9vZPe1OA/exec";
    let selectedEmp = "", selectedRank = "", selectedSalary = 0, yearConfigs = {};
    let chartObj = null;

    // 1. åˆå§‹åŒ–åå–®
    window.onload = () => {
        fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getStaff"})})
        .then(res => res.json()).then(r => {
            document.getElementById('staffMatrix').innerHTML = r.data.map(s => `
                <div class="staff-btn" onclick="selectEmp(this, '${s[0]}', '${s[3]}')">
                    <span class="rank-tag">${s[1]}</span>
                    <div style="font-size:1.2rem; font-weight:bold;">${s[0]}</div>
                    <div style="font-size:0.8rem; color:gray;">${new Date(s[3]).getFullYear()}å…¥è·</div>
                </div>
            `).join('');
        });
    };

    // 2. é¸æ“‡äººå“¡å¾Œçš„è¯å‹•
    async function selectEmp(el, name, hireDate) {
        selectedEmp = name;
        document.querySelectorAll('.staff-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');

        // æŠ“å–è©²å¹´åº¦èµ·å§‹è–ªè³‡
        const year = document.getElementById('calcYear').value;
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({
            action:"getSalary", name:name, date: year + "-01-01"
        })});
        const r = await res.json();
        selectedSalary = r.salary;
        selectedRank = r.rank;

        // æŠ“å–å¹´åº¦åƒæ•¸
        const resConfig = await fetch(API_URL, {method:"POST", body:JSON.stringify({
            action:"getConfigs", year: year
        })});
        const rC = await resConfig.json();
        yearConfigs = rC.yearConfigs;

        renderInputs(); // ä¾è·ç­‰æ¸²æŸ“ 12å€‹æœˆæˆ– 4å­£
    }

    // 3. æ¸²æŸ“è¼¸å…¥æ¡† (ä¿ç•™ L1 ä¸åŒé‚è¼¯)
    function renderInputs() {
        const grid = document.getElementById('inputGrid');
        const isL1 = (selectedRank === "L1");
        const count = isL1 ? 12 : 4;
        const labels = isL1 ? ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"] : ["ç¬¬ä¸€å­£","ç¬¬äºŒå­£","ç¬¬ä¸‰å­£","ç¬¬å››å­£"];
        
        grid.innerHTML = labels.map((l, i) => `
            <div style="text-align:center;">
                <div style="font-size:0.9rem;">${l}</div>
                <input type="number" class="q-score" value="80" oninput="runCalculation()">
            </div>
        `).join('');
        
        runCalculation();
    }

    // 4. æ ¸å¿ƒè¨ˆç®—å¼•æ“ (ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰å…¬å¼)
    function runCalculation() {
        const inputs = document.querySelectorAll('.q-score');
        let total = 0;
        inputs.forEach(i => total += parseFloat(i.value || 0));
        const avg = (total / inputs.length).toFixed(2);
        document.getElementById('avgSpan').innerText = avg;
        
        updateChart(Array.from(inputs).map(i => i.value));
        updateAdminTable(avg);
    }

    // 5. åœ–è¡¨åŠŸèƒ½ (å®Œæ•´ä¿ç•™)
    function updateChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.length === 12 ? ["1","2","3","4","5","6","7","8","9","10","11","12"] : ["Q1","Q2","Q3","Q4"],
                datasets: [{ label: 'è©•åˆ†è¶¨å‹¢', data: data, borderColor: '#3498db', tension: 0.3, fill: true }]
            },
            options: { maintainAspectRatio: false }
        });
    }

    // 6. ä¸»ç®¡æ¬Šé™é©—è­‰
    function verifyAdmin() {
        const p = prompt("è«‹è¼¸å…¥æˆæ¬Šå¯†ç¢¼ï¼š");
        if(p === "0000") {
            document.getElementById('adminZone').style.display = 'block';
            document.getElementById('unlockBtn').innerText = "âœ… å·²æˆæ¬Š";
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    }

    // å‰©é¤˜åŠŸèƒ½ï¼šsaveData, openPersonalReport (PDFæ¨£å¼), downloadChart ç­‰...
</script>
</body>
</html>
