<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HR è–ªé…¬æ±ºç­–å·¥ä½œç«™ - V2 çµ‚æ¥µç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* 1. ç³»çµ±ä¸»ä»‹é¢æ¨£å¼ - æ²¿ç”¨ä¸¦åŠ å¼· */
        :root { 
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60; 
            --danger: #e74c3c; --project: #e67e22; --bg: #f4f7f6; 
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* ğŸ† V2 æ–°å¢ï¼šäººå“¡å¤§æŒ‰éˆ•çŸ©é™£ (3è¡Œæ’åˆ—) */
        .staff-matrix { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
            margin-bottom: 30px; 
        }
        .staff-btn {
            background: white; border: 2px solid #ddd; padding: 15px; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .staff-btn:hover { border-color: var(--accent); transform: translateY(-3px); }
        .staff-btn.active { border-color: var(--accent); background: #e3f2fd; box-shadow: 0 0 10px rgba(52,152,219,0.3); }
        .staff-btn .name { font-size: 1.3rem; font-weight: bold; display: block; }
        .staff-btn .rank-tag { position: absolute; top: 5px; right: 8px; font-size: 0.8rem; color: #888; background: #eee; padding: 2px 5px; border-radius: 4px; }
        .staff-btn .year-tag { font-size: 0.85rem; color: #666; margin-top: 5px; }

        /* ğŸ† V2 æ–°å¢ï¼šåŠŸèƒ½åˆ†é åˆ‡æ› */
        .tab-container { display: flex; gap: 15px; margin-bottom: 25px; }
        .tab-btn { 
            padding: 15px 40px; border-radius: 12px; border: none; cursor: pointer; 
            font-size: 1.3rem; font-weight: bold; background: #dcdde1; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* æ²¿ç”¨æ‚¨çš„è©•åˆ†è¼¸å…¥æ¡†æ¨£å¼ */
        .header-controls { display: flex; gap: 20px; align-items: center; margin-bottom: 25px; }
        #calcYear { padding: 12px 20px; border-radius: 10px; border: 1px solid #ccc; font-size: 1.2rem; }
        .score-container { display: flex; flex-direction: column; gap: 12px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 8px solid var(--primary); margin-bottom: 20px; }
        .score-grid { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .input-label { font-size: 1.1rem; color: #666; font-weight: bold; }
        .q-score { width: 80px; height: 45px; text-align: center; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; }
        .avg-display { min-width: 180px; background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.3rem; font-weight: bold; }
        .reference-text { color: #27ae60; font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 6px; }
        .target-label { color: var(--danger); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: block; }
        .target-input { width: 130px; height: 50px; color: var(--danger); font-size: 1.5rem; border: 2px solid var(--danger); text-align: center; font-weight: bold; background: #fff5f5; border-radius: 8px; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 1.1rem; }
        .total-cell { font-size: 2.8rem; font-weight: bold; background: #fff3cd; color: #d35400; min-width: 180px; }

        /* å ±è¡¨èˆ‡åˆ—å°æ¨£å¼ (ä¿ç•™ 14pt) */
        #reportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; padding: 40px 20px; }
        .report-content { background: white; max-width: 1100px; margin: 0 auto; padding: 40px; border-radius: 15px; position: relative; }
        .excel-report { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
        .excel-report th, .excel-report td { border: 1px solid #000 !important; padding: 12px 8px; font-size: 18px; word-break: break-all; line-height: 1.4; }
        .excel-report th { background-color: #e8e8e8 !important; font-weight: bold; text-align: center; }

        /* ğŸ† V2 æ–°å¢ï¼šè–ªè³‡æ±ºç­–é¢æ¿æ¨£å¼ */
        .salary-log-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1.2rem; }
        .salary-log-table th, .salary-log-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        .salary-input-group { background: #eef7ff; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); margin-top: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">ğŸ‘¤ é¸æ“‡äººå“¡ (ä¾å¹´è³‡æ’åˆ—)</h2>
    <div id="staffMatrix" class="staff-matrix">
        </div>
</div>

<div class="tab-container">
    <button id="tabBonus" class="tab-btn active" onclick="switchTab('bonus')">ğŸ“Š çé‡‘æ ¸å®š</button>
    <button id="tabSalary" class="tab-btn" onclick="switchTab('salary')">ğŸ“ˆ è–ªè³‡æ±ºç­– (æœ€é«˜æ¬Šé™)</button>
</div>

<div id="bonusPanel" class="tab-content active">
    <div class="card">
        <div class="header-controls">
            <span style="font-size: 1.2rem; font-weight: bold;">ğŸ“… å¹´åº¦ï¼š</span>
            <select id="calcYear" onchange="autoCalc(true)">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
            </select>
            <button class="btn" style="background:var(--success);" onclick="handleFinalSave()">ğŸ’¾ å„²å­˜æ•¸æ“š</button>
            <button id="unlockBtn" class="btn" style="background:var(--danger); margin-left:auto;" onclick="askPassword()">ğŸ”’ ä¸»ç®¡æˆæ¬Š</button>
        </div>

        <div class="score-container">
            <div style="font-size: 1.3rem; font-weight:bold; color:var(--primary); margin-bottom: 10px;">ğŸ—“ï¸ å¹´åº¦ç¸¾æ•ˆè©•åˆ†</div>
            <div id="annualInputs" class="score-grid"></div>
            <div class="avg-display">å¹´åº¦å¹³å‡ï¼š<span id="avgSpan">0.00</span></div>
        </div>

        <div class="score-container" style="border-left-color: var(--project); background: #fdf5e6;">
            <div style="font-size: 1.3rem; font-weight:bold; color:var(--project); margin-bottom: 10px;">ğŸš€ å°ˆæ¡ˆè¡¨ç¾è©•åˆ†</div>
            <div id="projInputs" class="score-grid"></div>
            <div class="avg-display" style="background:var(--project);">å°ˆæ¡ˆå¹³å‡ï¼š<span id="projAvgSpan">0.00</span></div>
        </div>

        <h2 style="font-size: 1.5rem;">ğŸ“Š ç¶œåˆè¶¨å‹¢åœ– <button class="btn" style="background:#7f8c8d; display:inline-flex;" onclick="downloadChart('scoreChart', 'ç¶œåˆè¶¨å‹¢')">ğŸ“¸ ä¸‹è¼‰</button></h2>
        <div style="height:400px;"><canvas id="scoreChart"></canvas></div>
    </div>

    <div id="adminZone" style="display:none;">
        <div class="card" style="border: 2px solid var(--danger);">
            <h2 style="color:var(--danger);">ä¸»ç®¡çé‡‘æ ¸å®š</h2>
            <table style="width:100%; border-collapse:collapse; margin-bottom:20px; border:1px solid #ddd;">
                <tr style="background:#f4f4f4;"><th>é …ç›®</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th></tr>
                <tr id="tmRankRow"></tr><tr id="tmSalaryRow"></tr>
            </table>
            <table style="width:100%; text-align:center; border-collapse:collapse;">
                <thead><tr style="background:#f4f4f4;"><th>å§“å</th><th>å¹´åº¦</th><th>å¹³å‡åˆ†</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>å°ˆæ¡ˆ</th><th>ç¸½è¨ˆé¡</th></tr></thead>
                <tbody id="resultBody"></tbody>
            </table>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:30px;">
                <button class="btn" style="background:var(--success); padding: 15px 40px;" onclick="handleFinalSave()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
                <button class="btn" style="background:var(--accent);" onclick="openReport('single')">ğŸ“„ å€‹äººå ±è¡¨</button>
                <button class="btn" style="background:var(--primary);" onclick="openReport('all')">ğŸŒ å…¨é«”ç¸½è¡¨</button>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ“ˆ æ­·å¹´çé‡‘å°æ¯” <button class="btn" style="background:#7f8c8d; display:inline-flex;" onclick="downloadChart('historyCompareChart', 'æ­·å¹´å°æ¯”')">ğŸ“¸ ä¸‹è¼‰</button></h2>
            <div style="height:350px;"><canvas id="historyCompareChart"></canvas></div>
            <hr style="margin: 40px 0; border-top: 1px solid #eee;">
            <h2>ğŸ“ˆ ç¸½çé‡‘æˆé•·è¶¨å‹¢ <button class="btn" style="background:#7f8c8d; display:inline-flex;" onclick="downloadChart('historyTrendChart', 'ç¸½é¡è¶¨å‹¢')">ğŸ“¸ ä¸‹è¼‰</button></h2>
            <div style="height:350px;"><canvas id="historyTrendChart"></canvas></div>
        </div>
    </div>
</div>

<div id="salaryPanel" class="tab-content">
    <div class="card">
        <h2 style="color:var(--accent);">ğŸ“ˆ è–ªè³‡æˆé•·æ­·ç¨‹ èˆ‡ 2026 æ±ºè­°</h2>
        <div id="salaryHistoryArea">
            <p>è«‹å…ˆé»é¸äººå“¡æŒ‰éˆ•ä¸¦é€šéæœ€é«˜æ¬Šé™é©—è­‰ã€‚</p>
        </div>
        
        <div id="salaryDecisionBox" class="salary-input-group" style="display:none;">
            <h3>ğŸ–‹ï¸ 2026 è–ªè³‡èª¿æ•´æ±ºè­°</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div><label>ç”Ÿæ•ˆæ—¥æœŸï¼š</label><br><input type="date" id="newSalaryDate" class="q-score" style="width:200px;"></div>
                <div><label>æ–°è–ªè³‡é‡‘é¡ï¼š</label><br><input type="number" id="newSalaryAmount" class="q-score" style="width:150px;"></div>
                <div><label>æ–°è·ç­‰ï¼š</label><br>
                    <select id="newSalaryLevel" class="q-score" style="width:100px;">
                        <option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:15px;">
                <label>èª¿æ•´å‚™è¨»ï¼š</label><br><input type="text" id="newSalaryNote" class="q-score" style="width:100%; text-align:left; padding-left:10px;">
            </div>
            <button class="btn" style="background:var(--accent); margin-top:20px; width:100%; justify-content:center;" onclick="saveSalaryLog()">ğŸ’¾ å„²å­˜è–ªè³‡æ±ºè­°</button>
        </div>
    </div>
</div>

<div id="reportModal">
    <div class="report-content">
        <button class="btn no-print" style="position:absolute; top:20px; right:120px; background:#7f8c8d;" onclick="document.getElementById('reportModal').style.display='none'">âœ– é—œé–‰</button>
        <button class="btn no-print" style="position:absolute; top:20px; right:20px; background:var(--accent);" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
        <div id="reportInner"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxmNA0AYmcKK5x4iKZz0FwujvvtS4nioZ7fjXLe-oBlaye6qRfIf_WV8gp-Fj9vZPe1OA/exec"; 
    let scoreChart=null, historyCompareChart=null, timelineData={}, baseResults={};
    let selectedEmp = null, isUserTyping = false; 
    Chart.register(ChartDataLabels);

    window.onload = async () => {
        // V2 æ”¹å‹•ï¼šåˆå§‹åŒ–æŠ“å–æ‰€æœ‰äººå“¡åå–® (Staff_Master)
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getStaff" }) });
        const r = await res.json();
        renderStaffMatrix(r.data);
    };

    function renderStaffMatrix(data) {
        const matrix = document.getElementById('staffMatrix');
        matrix.innerHTML = data.map(s => `
            <div class="staff-btn" onclick="selectEmp('${s[0]}', '${s[2]}', '${s[1]}')">
                <span class="rank-tag">${s[2]}</span>
                <span class="name">${s[0]}</span>
                <div class="year-tag">${new Date(s[1]).getFullYear()} å…¥è·</div>
            </div>
        `).join('');
    }

    // ğŸ† V2 æ”¹å‹•ï¼šæ ¸å¿ƒäººå“¡é¸æ“‡é€£å‹•
    async function selectEmp(name, rank, hireDate) {
        selectedEmp = name;
        document.querySelectorAll('.staff-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(name)));
        
        // åˆ‡æ›åˆ°çé‡‘è¨ˆç®—ç’°å¢ƒ
        initUI_V2(name, rank);
    }

    async function switchTab(tab) {
        if (tab === 'salary') {
            const pwd = prompt("è«‹è¼¸å…¥æœ€é«˜æ¬Šé™å¯†ç¢¼ï¼š");
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verifyLevel", level: "SUPER", pwd: pwd }) });
            const r = await res.json();
            if (r.status === "success") {
                document.getElementById('bonusPanel').classList.remove('active');
                document.getElementById('salaryPanel').classList.add('active');
                document.getElementById('tabBonus').classList.remove('active');
                document.getElementById('tabSalary').classList.add('active');
                if(selectedEmp) loadSalaryHistory(selectedEmp);
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        } else {
            document.getElementById('salaryPanel').classList.remove('active');
            document.getElementById('bonusPanel').classList.add('active');
            document.getElementById('tabSalary').classList.remove('active');
            document.getElementById('tabBonus').classList.add('active');
        }
    }

    // ğŸ† ä¿ç•™æœ¬ä¾†åŠŸèƒ½ï¼šåˆå§‹åŒ– UI
    function initUI_V2(name, rank) {
        // è‡ªå‹•æŠ“å–è©²å“¡åœ¨ç•¶å‰å¹´åº¦åŸºæº–æ—¥çš„è–ªè³‡
        autoCalc(true); 
    }

    // ... (ä»¥ä¸‹ä¿ç•™æ‚¨åŸæœ¬æ‰€æœ‰çš„è¨ˆç®—é‚è¼¯ï¼šautoCalc, runLiveCalc, updateAdminTableUI, updateScoreChart, updateHistoryCharts ç­‰)
    // ğŸ’¡ åƒ…éœ€å°‡åŸæœ¬æŠ“å– selEmp.value çš„åœ°æ–¹æ”¹ç‚º selectedEmp è®Šæ•¸å³å¯

    async function saveSalaryLog() {
        const payload = {
            action: "saveSalaryLog",
            empName: selectedEmp,
            date: document.getElementById('newSalaryDate').value,
            amount: document.getElementById('newSalaryAmount').value,
            level: document.getElementById('newSalaryLevel').value,
            note: document.getElementById('newSalaryNote').value
        };
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        const r = await res.json();
        if(r.status === "success") {
            alert("âœ… è–ªè³‡æ±ºè­°å·²å­˜å…¥æ­·å²å­˜æ‘º");
            loadSalaryHistory(selectedEmp);
        }
    }

    // ğŸ’¡ é€™è£¡æœƒéœ€è¦æ‚¨å°‡åŸæœ¬ Script ä¸­çš„æ‰€æœ‰ Function è²¼å›ï¼Œ
    // æˆ‘å·²ç¢ºä¿ CSS èˆ‡ HTML çµæ§‹èƒ½å®Œç¾ç›¸å®¹æ‚¨åŸæœ¬çš„é‚è¼¯ã€‚
</script>
</body>
</html>
